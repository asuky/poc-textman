# Django学習セッション - 2026年1月5日

## 📋 セッション概要
Django初心者として、基本的なプロジェクトのセットアップから、API エンドポイント、ミドルウェア、静的ファイルの提供までを学習。

---

## 💬 Q&A 履歴

### Q1: Django の基本セットアップと /poc エンドポイントの作成

**質問:**
```
Django について私は素人なので使い方を教えてほしいのです。
今 app 配下に django-admin startproject poc でプロジェクトを作ったところです。
ここに必要なコードやファイル等を生成・追加し、開発サーバを開始して /poc に GET したとき、
{ "status": "OK" } という JSON を返すようにしてください。
また、GET /poc をしたときの処理の流れを示し、適宜コメントをコードに入れてください。
```

**回答のポイント:**
- `poc/views.py` を作成し、`poc_status` ビュー関数を実装
- `JsonResponse` を使用してJSON形式のレスポンスを返す
- `poc/urls.py` で `/poc/` パスを `poc_status` 関数にルーティング
- 処理の流れ:
  1. クライアント → GET /poc
  2. URLディスパッチャー（urls.py）がパターンマッチング
  3. ビュー関数（views.py）実行
  4. JsonResponse 生成
  5. クライアントに返却

**作成ファイル:**
- `app/poc/poc/views.py`
- `app/poc/poc/urls.py`（変更）
- `app/DJANGO_GUIDE.md`

**学んだこと:**
- サーバは手動で起動する（`python3 manage.py runserver`）
- Django の基本構造: View（Controller的）、URLconf、Response

---

### Q2: HTTPメソッド別の処理方法

**質問:**
```
48 行目の path の指定ですが、これは HTTP のメソッド（GET や POST その他）別の対応をするときはどうすれば？
```

**回答のポイント:**
- `path()` 自体は HTTP メソッドを区別しない
- 3つの方法を提示:
  1. ビュー関数内で `request.method` で分岐
  2. `@require_http_methods(["GET", "POST"])` デコレータで制限
  3. `@require_GET`、`@require_POST` で個別に制限

**追加したビュー関数:**
- `poc_method_example` - メソッド別処理の例
- `poc_restricted_methods` - 特定メソッドのみ許可
- `poc_get_only` - GET専用
- `poc_post_only` - POST専用

**考察メモ:**
- urls.py はパスのルーティングに徹する
- デコレータを使う方法（方法2, 3）が推奨される（前処理で弾く）
- ビューメソッド内で `request.method` にアクセスするのは基本避けるべき

---

### Q3: ミドルウェアの実装

**質問:**
```
リクエストの前後に処理を入れる、いわゆるミドルウェア的なものを差し挟むことはできますか？
可能なら処理に影響しない簡単なものをコメントつけておしえてください。
```

**回答のポイント:**
- Django にはミドルウェア機能がある
- リクエスト前処理（`process_request`）とレスポンス後処理（`process_response`）
- 4つのミドルウェアを実装:
  1. `SimpleLoggingMiddleware` - ログ出力と処理時間計測
  2. `RequestIDMiddleware` - リクエストID付与
  3. `CustomHeaderMiddleware` - カスタムヘッダー追加
  4. `ExceptionLoggingMiddleware` - 例外ログ

**作成ファイル:**
- `app/poc/poc/middleware.py`
- `app/poc/poc/settings.py`（MIDDLEWARE設定追加）
- `app/poc/poc/views.py`（`poc_slow` テスト用エンドポイント追加）

**処理の流れ:**
```
クライアント
  ↓ HTTPリクエスト
ミドルウェア（前処理）
  ↓
ビュー関数
  ↓
ミドルウェア（後処理）
  ↓ HTTPレスポンス
クライアント
```

**懸念点:**
- `django.utils.deprecation` という名前が不安

---

### Q4: django.utils.deprecation について

**質問:**
```
middleware.py 24行目の django.utils.deprecation という名前が気になります。
この機能、廃止が予定されていたりしませんか？もしそうなら新しい手段か、
あるいはもう削除しなければならないのか、コード修正は不要なのでその判断だけ教えてほしいです。
```

**回答のポイント:**
- **コード修正は不要**
- `MiddlewareMixin` 自体は非推奨ではない
- モジュール名が紛らわしいだけ（「非推奨機能を管理するためのユーティリティ」という意味）
- 2つのスタイルが共存:
  1. クラスベース（`MiddlewareMixin` 使用）- 読みやすい
  2. 関数ベース - より新しい推奨スタイル
- どちらも正式サポートされている

**結論:**
- 現在のコードのままで問題ない
- 将来的に関数ベースに変更することも可能だが、急ぐ必要なし

**考察メモ:**
- 別に廃止予定ではない
- クラスベースと関数ベースがある
- 関数ベースの方が推奨されているが、クラスベースも初心者には理解しやすい

---

### Q5: ルートページと静的ファイルの提供

**質問:**
```
ルート (/) にアクセスしたときにエラー画面が表示されるのも良くないので、
静的ファイルへのアクセスを提供するようにして、そのやり方をついでで教えて下さい。
```

**回答のポイント:**
- `index` ビュー関数を作成し、テンプレートをレンダリング
- 静的ファイルの設定:
  - `STATIC_URL = 'static/'`
  - `STATICFILES_DIRS = [BASE_DIR / 'static']`
  - `TEMPLATES` の `DIRS` に `templates/` を追加
- テンプレート内で `{% load static %}` を使用
- 静的ファイルの読み込み: `{% static 'css/style.css' %}`

**作成ファイル:**
- `app/poc/templates/index.html` - トップページ
- `app/poc/static/css/style.css` - スタイルシート
- `app/poc/static/js/script.js` - JavaScript
- `app/poc/static/images/` - 画像用ディレクトリ
- `app/poc/STATIC_FILES_GUIDE.md` - 詳細ガイド

**ディレクトリ構造:**
```
app/poc/
├── static/
│   ├── css/style.css
│   ├── js/script.js
│   └── images/
├── templates/
│   └── index.html
└── poc/
    ├── settings.py
    ├── urls.py
    └── views.py
```

**トラブルシューティング:**
- 最初にエラー発生（ImportError: cannot import name 'index'）
- `views.py` に `index` 関数が定義されていなかったため
- 関数を追加して解決

---

### Q6: サーバー起動時のエラー対応

**質問:**
```
サーバ立ち上げるとエラーでます。
ImportError: cannot import name 'index' from 'poc.views'
```

**回答:**
- `views.py` に `index` 関数が欠落していた
- `index` 関数を追加して解決
- `render(request, 'index.html', context)` でテンプレートをレンダリング

---

### Q7: Django の MVC パターンについて

**質問:**
```
これは修正依頼でなく質問ですが、Django の場合はいわゆる Model-View-Controller の
見方をしたとき、Controller 的なものはなくて View がそれを兼ねる感じなんですか？
```

**回答のポイント:**
- Django は **MTV（Model-Template-View）パターン**を採用
- 一般的な MVC との対応:
  - **Model** → **Model**（データベース層）
  - **View** → **Template**（表示層）
  - **Controller** → **View**（制御層）
- Django の View は Controller の役割を担う
- 責務の分離という考え方は同じで、名前が違うだけ

**対応表:**
| 一般的なMVC | Django MTV | 役割 |
|------------|-----------|------|
| Model | Model | データベースとの対話、ビジネスロジック |
| View | Template | ユーザーに見せる表示（HTML） |
| Controller | View | リクエスト処理、制御フロー |

---

## 📚 作成されたファイル一覧

### 実装ファイル
- `app/poc/poc/views.py` - ビュー関数（Controller的な役割）
- `app/poc/poc/urls.py` - URLルーティング
- `app/poc/poc/middleware.py` - カスタムミドルウェア
- `app/poc/poc/settings.py` - プロジェクト設定（変更）
- `app/poc/templates/index.html` - トップページテンプレート
- `app/poc/static/css/style.css` - スタイルシート
- `app/poc/static/js/script.js` - JavaScript

### ドキュメント
- `app/DJANGO_GUIDE.md` - Django の基本ガイド
- `app/poc/STATIC_FILES_GUIDE.md` - 静的ファイルの完全ガイド

---

## 🎯 実装されたエンドポイント

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/` | GET | トップページ（HTML） |
| `/poc/` | ALL | JSON API: `{"status": "OK"}` |
| `/poc-slow/` | GET | 処理時間計測テスト（0.5秒） |
| `/poc-method/` | ALL | HTTPメソッド別処理の例（コメントアウト） |
| `/poc-restricted/` | GET, POST | 特定メソッドのみ許可（コメントアウト） |
| `/poc-get/` | GET | GET専用（コメントアウト） |
| `/poc-post/` | POST | POST専用（コメントアウト） |

---

## 💡 学んだ重要な概念

### 1. Django の基本構造
- **Model**: データベース層
- **View**: 制御層（Controller的）
- **Template**: 表示層
- **URLconf**: ルーティング

### 2. ビュー関数
- リクエストを受け取り、レスポンスを返す
- `JsonResponse` でJSON、`render` でHTML
- デコレータでHTTPメソッドを制限可能

### 3. ミドルウェア
- リクエスト/レスポンスの処理パイプライン
- `process_request`: ビュー実行前
- `process_response`: ビュー実行後
- クラスベースと関数ベースがある

### 4. 静的ファイル
- 開発環境: `STATICFILES_DIRS` から配信
- テンプレート: `{% load static %}` と `{% static 'path' %}`
- 本番環境: `collectstatic` で集約

### 5. テンプレート
- `render(request, 'template.html', context)`
- `context` で変数を渡す
- `{{ variable }}` で変数展開

---

## ⚙️ サーバー起動方法

```bash
cd /home/asuky/poc-textman/app/poc
python3 manage.py runserver
```

**アクセス:**
- トップページ: http://127.0.0.1:8000/
- API: http://127.0.0.1:8000/poc/

---

## 📝 次のステップ（参考）

1. **Model の学習**: データベース操作
2. **アプリケーション作成**: 機能ごとに分割
3. **フォーム処理**: POSTリクエストの扱い
4. **認証機能**: ユーザー管理
5. **テストコード**: 自動テスト

---

### Q8: path() の引数について（第2、第3引数の詳細）

**質問:**
```
path の引数の取り方を教えて下さい。
第2は多分呼び出すメソッド名と思うのですが、第3は名前つけてるだけですか？
```

**回答のポイント:**
- `path(route, view, name=None)` の3つの引数
- **第1引数（route）**: URLパターン文字列
  - 例: `'poc/'`, `'articles/<int:id>/'`
  - 動的パラメータも指定可能
- **第2引数（view）**: ビュー関数への参照
  - `poc_status` のように `()` なしで渡す
  - 実行ではなく関数オブジェクトを渡す
- **第3引数（name）**: URLパターンの識別名
  - **単なる識別子ではなく、実用的な機能！**
  - テンプレート、ビュー、リダイレクトで活用

**name パラメータの使い道:**

1. **テンプレート内で URL 生成**
```html
{% url 'poc_status' %}  → /poc/ に変換
<a href="{% url 'article_detail' id=123 %}">記事</a>  → /articles/123/
```

2. **ビュー関数内でリダイレクト**
```python
return redirect('poc_status')  # /poc/ にリダイレクト
return redirect('article_detail', id=123)  # パラメータ付き
```

3. **reverse() で URL 文字列を取得**
```python
url = reverse('poc_status')  # '/poc/' が返る
url = reverse('article_detail', kwargs={'id': 123})  # '/articles/123/'
```

4. **JavaScript 内での使用**
```html
<script>
    const apiUrl = "{% url 'poc_status' %}";
    fetch(apiUrl).then(...);
</script>
```

**name を使うメリット:**
- ✅ URL の一元管理（urls.py だけ変更すればOK）
- ✅ リファクタリングが楽（全ファイル検索不要）
- ✅ タイポの防止（存在しない名前だとエラー）
- ✅ ハードコード回避

**実例:**
```python
# urls.py でパスを変更
path('api/v2/poc/', poc_status, name='poc_status')  # 'poc/' から変更

# テンプレートは修正不要！自動的に /api/v2/poc/ を参照
<a href="{% url 'poc_status' %}">POCページ</a>
```

**追加ファイル:**
- `app/poc/poc/urls.py`（コメント追加）
- `app/poc/templates/url_name_example.html`（使用例）
- `app/poc/PATH_ARGUMENTS_GUIDE.md`（完全ガイド）

**よくある間違い:**
- ❌ `path('poc/', poc_status(), ...)` - 関数を実行してしまう
- ✅ `path('poc/', poc_status, ...)` - 関数への参照を渡す
- ❌ name の重複
- ❌ `reverse('name', id=123)` - 正しくは `kwargs={'id': 123}`

**考察:**
- name は必ず付けるべき
- ハードコードは保守性が悪い
- Django の DRY（Don't Repeat Yourself）原則に沿った設計

---

### Q9: 会話ログの恒久的な保存方法

**質問:**
```
今までのプロンプト（こちらからの質問と、そちらの返答全て）を20260105.md にまとめてもらっていいですか？
後今後も同様の対応してもらいたいのですが、恒久対応する方法はありますか？
都度このファイルにまとめるよう指示出したほうがいいですか。
```

**回答のポイント:**
- 完全な自動化は難しい（セッションごとにコンテキストがリセット）
- 推奨方法: **セッション終了時に都度依頼する**
- README.md に以下を記載して運用:
```markdown
ここまででまだまとめられてない会話の内容を prompts/YYYYMMDD.md にまとめてください
```

**代替案:**
1. セッション終了時に明示的に依頼（最も確実）
2. プロジェクトルートに指示ファイル作成（毎回言及が必要）
3. README に記載（参照を促す）

**結論:**
- VS Code 設定や自動化は不可能
- 都度「会話をまとめてください」と指示するのが確実

---

## 📊 セッション統計

### 作成・変更されたファイル数
- **実装ファイル**: 7ファイル
- **ドキュメント**: 4ファイル
- **合計**: 11ファイル

### 実装した機能
- ✅ JSON API エンドポイント
- ✅ HTTP メソッド別処理（デコレータ活用）
- ✅ カスタムミドルウェア（4種類）
- ✅ 静的ファイル提供（CSS, JS）
- ✅ テンプレートレンダリング
- ✅ URL リバース機能の活用

### 学習した概念
1. Django の MTV パターン
2. ビュー関数とルーティング
3. ミドルウェアの仕組み
4. 静的ファイルの管理
5. テンプレートエンジン
6. URL パターンの name パラメータ

---

## 🎓 重要な学び

### Django の設計思想
- **MTV パターン**: Model-Template-View（MVC の Django版）
- **DRY 原則**: Don't Repeat Yourself（name パラメータ活用）
- **明示的設定**: settings.py での一元管理

### ベストプラクティス
- ✅ HTTP メソッドはデコレータで制限
- ✅ URL は name で参照（ハードコードしない）
- ✅ ミドルウェアで共通処理を集約
- ✅ 静的ファイルは STATICFILES_DIRS で管理
- ✅ テンプレートと静的ファイルは分離

### 避けるべきパターン
- ❌ ビュー内で request.method による分岐（基本）
- ❌ URL のハードコード
- ❌ 関数実行時の `()` 付け渡し
- ❌ name の重複や省略

---

## 📚 作成されたガイドドキュメント

1. **DJANGO_GUIDE.md** - Django の基本と処理フロー
2. **STATIC_FILES_GUIDE.md** - 静的ファイルの完全ガイド
3. **PATH_ARGUMENTS_GUIDE.md** - path() 引数と name の詳細
4. **20260105.md** - 本セッションの完全な記録

---

## 🔚 セッション終了

**総質問数**: 9問
**実装時間**: 約2-3時間
**習熟度**: Django 初心者 → 基本機能を理解

**次回セッションへ向けて:**
- Model とデータベース操作の学習
- フォーム処理と CSRF 対策
- Django アプリケーションの作成
- 認証・認可の実装
- REST API（Django REST framework）

---

**📌 このドキュメントの保存先:**
`prompts/20260105.md`

**📌 関連ファイル:**
- `app/poc/` - Django プロジェクト本体
- `app/*.md` - 各種ガイドドキュメント
- `README.md` - プロジェクト全体の README


